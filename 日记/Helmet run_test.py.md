```mermaid
flowchart TD
    A[开始 run_test] --> B[记录日志信息]
    B --> C[构建输出路径]
    
    C --> D{检查输出文件}
    D -->|文件存在且不覆盖| E[返回输出路径]
    D -->|需要处理| F[设置随机种子]
    
    F --> G[加载数据 load_data]
    G --> H[创建 DataLoader]
    
    H --> I[初始化指标收集器]
    I --> J[进入推理模式 torch.inference_mode]
    
    J --> K[开始样本处理循环]
    
    K --> L{是否统计token}
    L -->|是| M[记录输入长度]
    L -->|否| N[生成模型输出]
    
    N --> O{输出是否为空}
    O -->|是| P[记录跳过信息]
    O -->|否| Q[处理模型输出]
    
    Q --> R{是否使用chat模板}
    R -->|否| S[添加系统提示]
    R -->|是| T[后处理输出]
    S --> T
    
    T --> U[更新指标]
    U --> V[收集结果]
    
    V --> W{是否需要打印示例}
    W -->|是| X[打印详细信息]
    W -->|否| Y{是否还有样本}
    X --> Y
    
    Y -->|是| K
    Y -->|否| Z[计算性能指标]
    
    Z --> AA{是否只统计token}
    AA -->|是| AB[输出token统计]
    AA -->|否| AC[计算平均指标]
    
    AC --> AD[准备输出数据]
    AD --> AE{是否指定输出目录}
    AE -->|是| AF[保存结果文件]
    AE -->|否| AG[返回输出路径]
    AF --> AG

    subgraph 性能监控
    Z1[计算内存使用]
    Z2[计算处理速度]
    Z --> Z1
    Z1 --> Z2
    Z2 --> AA
    end
```


1. 初始化阶段：

	- 记录日志
	- 构建输出路径
	- 检查文件是否存在

2.  数据准备：

	- 设置随机种子
	
	- 加载数据
	
	- 创建 DataLoader

3. 主处理循环：

	- 对每个样本进行处理
	
	- 生成模型输出
	
	- 后处理和指标收集
	
	- 可选的示例打印

4. 结果处理：

	- 计算性能指标（内存使用、处理速度）
	
	- 计算平均指标
	
	- 保存结果

5. 特殊功能：

	- token 统计模式
	
	- 示例打印控制
	
	- 性能监控

这个流程图展示了 run_test 函数的详细执行过程，包括所有主要的条件分支和数据流向。需要对某个部分进行更详细的说明吗？